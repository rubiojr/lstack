#!/bin/bash
set -e

BASE_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )/../" && pwd )"

lstack() {
  $BASE_PATH/lstack $@
}

cleanup() {
  lstack destroy >/dev/null 2>&1 || true
}
trap "cleanup" EXIT

lstack bootstrap
cirros_ip=$(lstack nova list |grep -o "private=.*\s"|cut -d= -f2)
# A test Cirros VM is created by default when bootstrapping
# The SSH port should be reachable if everything went fine.
lstack ssh "echo | nc $cirros_ip 22" | grep dropbear > /dev/null
lstack destroy
echo OK!
